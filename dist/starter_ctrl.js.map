{"version":3,"sources":["../src/starter_ctrl.js"],"names":["MetricsPanelCtrl","_","$","TimeSeries","kbn","panelDefaults","bgColor","format","thresholds","colors","colorBackground","colorValue","sparkline","show","full","lineColor","fillColor","StarterCtrl","$scope","$injector","defaultsDeep","panel","events","on","onInitEditMode","bind","onPanelTeardown","render","onDataReceived","onDataError","onDataSnapshotLoad","onSparklineColorChange","onSparklineFillChange","addEditorTab","unitFormats","getUnitFormats","subItem","value","refresh","dataList","data","map","seriesHandler","seriesData","series","datapoints","alias","target","flotpairs","getFlotPairs","nullPointMode","stats","formatFunc","valueFormats","valueFormatted","i","length","thresholdColor","getColorForValue","isFinite","first","tmp","panelColorIndex","color","snapshotData","newColor","scope","elem","attrs","ctrl","$panelContainer","find","css","split","Number","strVal","trim","setThresholds","rootElem","addSparklines","renderingCompleted","width","setTimeout","empty","height","plotCanvas","plotCss","position","bottom","left","dynamicHeightMargin","Math","round","floor","options","legend","lines","fill","lineWidth","yaxes","xaxis","mode","min","range","from","valueOf","max","to","grid","hoverable","append","plotSeries","plot","templateUrl"],"mappings":"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","file":"starter_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport './css/starter-panel.css!';\nimport TimeSeries from 'app/core/time_series2';\nimport kbn from 'app/core/utils/kbn';\n\nconst panelDefaults = {\n  bgColor: null,\n  format: 'none',\n  thresholds: '',\n  colors: ['#299c46', 'rgba(237, 129, 40, 0.89)', '#d44a3a'],\n  colorBackground: true,\n  colorValue: false,\n  sparkline: {\n    show: true,\n    full: false,\n    lineColor: 'rgb(31, 120, 193)',\n    fillColor: 'rgba(31, 118, 189, 0.18)',\n  },\n};\n\nexport class StarterCtrl extends MetricsPanelCtrl {\n  constructor($scope, $injector) {\n    super($scope, $injector);\n\n    // Set panel defaults for properties that the user has not set explicitly\n    _.defaultsDeep(this.panel, panelDefaults);\n\n    // init-edit-mode event is triggered when the user clicks on edit\n    // the editor tabs are initialized in the handler\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n\n    // The panel-teardown event is useful for cleaning up to avoid memory leaks\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n\n    // The panel initialized event can be useful for panels that inherit PanelCtrl instead of MetricsPanelCtrl\n    // With a MetricsPanelCtrl panel, you usually want to wait for some data to be received\n    this.events.on('panel-initialized', this.render.bind(this));\n\n    // The data-received event is triggered when the datasource returns with data\n    this.events.on('data-received', this.onDataReceived.bind(this));\n\n    // The data-error event can be handled by showing a friendly error message to the user or to ignore the error\n    this.events.on('data-error', this.onDataError.bind(this));\n\n    // The data-snapshot-load event is triggered when the dashboard is loading as a snapshot\n    // Read more about saving and loading snapshot data here:\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n\n    this.onSparklineColorChange = this.onSparklineColorChange.bind(this);\n    this.onSparklineFillChange = this.onSparklineFillChange.bind(this);\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-starter-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.refresh();\n  }\n\n  onPanelTeardown() {\n  }\n\n  onDataReceived(dataList) {\n    if (!dataList) return;\n\n    this.data = dataList.map(this.seriesHandler.bind(this));\n    this.render();\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints || [],\n      alias: seriesData.target,\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    series.value = series.stats['current'];\n    const formatFunc = kbn.valueFormats[this.panel.format];\n    series.valueFormatted = formatFunc(series.value, 0, 1);\n    return series;\n  }\n\n  setThresholds(thresholds) {\n    for (let i = 0; i < this.data.length; i++) {\n      this.data[i].thresholdColor = this.getColorForValue(this.data[i].value, thresholds);\n    }\n  }\n\n  getColorForValue(value, thresholds) {\n    if (!_.isFinite(value)) {\n      return null;\n    }\n    for (let i = thresholds.length; i > 0; i--) {\n      if (value >= thresholds[i - 1]) {\n        return this.panel.colors[i];\n      }\n    }\n    return _.first(this.panel.colors);\n  }\n\n  invertColorOrder() {\n    const tmp = this.panel.colors[0];\n    this.panel.colors[0] = this.panel.colors[2];\n    this.panel.colors[2] = tmp;\n    this.render();\n  }\n\n  onColorChange(panelColorIndex) {\n    return color => {\n      this.panel.colors[panelColorIndex] = color;\n      this.render();\n    };\n  }\n\n  onDataError() {\n    this.onDataReceived();\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData);\n  }\n\n  onSparklineColorChange(newColor) {\n    this.panel.sparkline.lineColor = newColor;\n    this.render();\n  }\n\n  onSparklineFillChange(newColor) {\n    this.panel.sparkline.fillColor = newColor;\n    this.render();\n  }\n\n  /*\n  The link function is an Angular function that can be used to access the HTML element for the panel\n  */\n  /* eslint class-methods-use-this: 0 */\n  link(scope, elem, attrs, ctrl) {\n    this.events.on('render', () => {\n      const $panelContainer = elem.find('.panel-container');\n\n      if (this.panel.bgColor) {\n        $panelContainer.css('background-color', this.panel.bgColor);\n      } else {\n        $panelContainer.css('background-color', '');\n      }\n\n      if (!ctrl.data) {\n        return;\n      }\n\n      const thresholds = this.panel.thresholds.split(',').map(strVal => {\n        return Number(strVal.trim());\n      });\n      this.setThresholds(thresholds);\n\n      const rootElem = elem.find('.temp-sparkline');\n\n      addSparklines(rootElem);\n      ctrl.renderingCompleted();\n    });\n\n    function addSparklines(rootElem) {\n      const width = elem.width() + 20;\n      if (width < 30) {\n        // element has not gotten it's width yet\n        // delay sparkline render\n        setTimeout(() => addSparklines(rootElem), 30);\n        return;\n      }\n\n      rootElem.empty();\n\n      const height = ctrl.height;\n      const plotCanvas = $('<div></div>');\n      const plotCss = {};\n      plotCss.position = 'absolute';\n\n      if (ctrl.panel.sparkline.full) {\n        plotCss.bottom = '5px';\n        plotCss.left = '-5px';\n        plotCss.width = width - 10 + 'px';\n        const dynamicHeightMargin = height <= 100 ? 5 : Math.round(height / 100) * 15 + 5;\n        plotCss.height = height - dynamicHeightMargin + 'px';\n      } else {\n        plotCss.bottom = '0px';\n        plotCss.left = '-5px';\n        plotCss.width = width - 10 + 'px';\n        plotCss.height = Math.floor(height * 0.25) + 'px';\n      }\n\n      plotCanvas.css(plotCss);\n\n      const options = {\n        legend: { show: false },\n        series: {\n          lines: {\n            show: true,\n            fill: 1,\n            lineWidth: 1,\n            fillColor: ctrl.panel.sparkline.fillColor,\n          },\n        },\n        yaxes: { show: false },\n        xaxis: {\n          show: false,\n          mode: 'time',\n          min: ctrl.range.from.valueOf(),\n          max: ctrl.range.to.valueOf(),\n        },\n        grid: { hoverable: false, show: false },\n      };\n\n      rootElem.append(plotCanvas);\n\n      const plotSeries = {\n        data: ctrl.data[0].flotpairs,\n        color: ctrl.panel.sparkline.lineColor,\n      };\n\n      $.plot(plotCanvas, [plotSeries], options);\n    }\n  }\n}\n\nStarterCtrl.templateUrl = 'module.html';\n"]}